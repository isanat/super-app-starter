// Louvor Conectado - Sistema de Escala de Músicos para Igrejas
// Foco: Igreja Adventista do Sétimo Dia

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== USUÁRIOS ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String
  phone         String?        // WhatsApp para notificações
  avatar        String?
  role          Role      @default(MUSICIAN)
  isActive      Boolean   @default(true)
  
  // Sistema de penalização
  penaltyPoints Int       @default(0)     // Pontos de penalização
  isBlocked     Boolean   @default(false) // Bloqueado por penalidades
  blockedUntil  DateTime?                  // Até quando está bloqueado
  
  // Disponibilidade padrão (JSON)
  // Ex: {"sabado_manha": true, "sabado_tarde": true, "sabado_noite": false}
  weeklyAvailability String?  // JSON com disponibilidade semanal
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  churchId      String?

  // Relacionamentos
  profile        MusicianProfile?
  church         Church?               @relation("ChurchMembers", fields: [churchId], references: [id])
  churchAdmin    Church?               @relation("ChurchAdmin")
  eventsCreated  Event[]               @relation("EventCreator")
  invitations    EventInvitation[]     // Convites recebidos
  notifications  Notification[]
  penaltyHistory PenaltyHistory[]      // Histórico de penalizações
  accounts       Account[]
  sessions       Session[]

  @@index([email])
  @@index([role])
}

enum Role {
  ADMIN
  DIRECTOR
  MUSICIAN
  SINGER      // Cantor
  INSTRUMENTALIST // Instrumentalista
}

// ==================== PERFIL DO MÚSICO ====================

model MusicianProfile {
  id           String   @id @default(cuid())
  userId       String   @unique
  
  // Instrumentos e habilidades (JSON arrays)
  instruments  String   // Ex: ["violao", "guitarra", "baixo"]
  vocals       String?  // Ex: ["tenor", "baritono", "soprano"]
  skills       String?  // Nível de cada instrumento
  
  // Experiência
  yearsExperience Int?
  bio          String?
  
  // Estatísticas
  totalEvents  Int      @default(0)     // Total de eventos participados
  totalCancels Int      @default(0)     // Total de cancelamentos
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==================== IGREJA ====================

model Church {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  
  // Endereço
  address     String?
  city        String?
  state       String?
  
  // Contato
  phone       String?
  email       String?
  
  // Configurações específicas IASD
  // Ex: {"sabadoEscola": "9:00", "cultoDivino": "10:30", "sabadoTarde": "16:00"}
  serviceTimes String?  // JSON com horários dos cultos
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members      User[]          @relation("ChurchMembers")
  admin        User            @relation("ChurchAdmin", fields: [adminId], references: [id])
  adminId      String          @unique
  events       Event[]
  
  @@index([slug])
}

// ==================== EVENTOS ====================

model Event {
  id            String      @id @default(cuid())
  churchId      String
  title         String
  description   String?
  
  // Tipo de evento (cultos IASD)
  type          EventType
  
  // Data e horário
  date          DateTime
  endTime       DateTime?
  
  // Local
  location      String?
  
  // Status
  status        EventStatus @default(DRAFT)
  
  // Escala gerada automaticamente?
  autoGenerated Boolean     @default(false)
  
  // Notas e observações
  notes         String?
  
  // Repertório (JSON array de IDs de músicas)
  setlist       String?
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  createdById   String

  church        Church          @relation(fields: [churchId], references: [id], onDelete: Cascade)
  createdBy     User            @relation("EventCreator", fields: [createdById], references: [id])
  invitations   EventInvitation[]  // Convites para este evento
  
  @@index([churchId, date])
  @@index([status])
}

enum EventType {
  SABBATH_SCHOOL      // Escola Sabatina
  DIVINE_SERVICE      // Culto Divino
  SABBATH_AFTERNOON   // Sábado à Tarde
  WEDNESDAY_SERVICE   // Culto de Quarta
  SPECIAL_EVENT       // Evento Especial
  REHEARSAL           // Ensaio
  OTHER               // Outro
}

enum EventStatus {
  DRAFT       // Rascunho (ainda montando a escala)
  PUBLISHED   // Publicado (convites enviados)
  CONFIRMED   // Confirmado (todos confirmaram)
  IN_PROGRESS // Em andamento
  COMPLETED   // Concluído
  CANCELLED   // Cancelado
}

// ==================== CONVITES/ESCALA ====================

model EventInvitation {
  id           String             @id @default(cuid())
  eventId      String
  userId       String
  
  // Função no evento
  role         EventRole          // Cantor, instrumentista, etc.
  instrument   String?            // Se instrumentista, qual instrumento
  vocalPart    String?            // Se cantor, qual voz (tenor, soprano, etc.)
  
  // Status
  status       InvitationStatus   @default(PENDING)
  
  // Quando foi convidado e quando respondeu
  invitedAt    DateTime           @default(now())
  respondedAt  DateTime?
  
  // Motivo do cancelamento (se houver)
  cancelReason String?
  
  // Penalização aplicada?
  penaltyApplied Boolean          @default(false)
  penaltyPoints  Int?
  
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([status])
}

enum EventRole {
  SINGER          // Cantor
  INSTRUMENTALIST // Instrumentalista
  WORSHIP_LEADER  // Dirigente
  SOUND_TECH      // Técnico de som
  OTHER           // Outro
}

enum InvitationStatus {
  PENDING    // Aguardando resposta
  CONFIRMED  // Confirmado
  DECLINED   // Recusado
  CANCELLED  // Cancelou após confirmar (penalizado)
}

// ==================== PENALIZAÇÕES ====================

model PenaltyHistory {
  id          String   @id @default(cuid())
  userId      String
  eventId     String?  // Evento relacionado
  invitationId String? // Convite relacionado
  
  points      Int      // Pontos da penalização
  reason      String   // Motivo
  description String?  // Descrição detalhada
  
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

// ==================== NOTIFICAÇÕES ====================

model Notification {
  id          String             @id @default(cuid())
  userId      String
  title       String
  message     String
  type        NotificationType
  
  // Dados extras (JSON)
  data        String?
  
  // Status
  isRead      Boolean            @default(false)
  readAt      DateTime?
  
  // Entrega
  sentViaApp  Boolean            @default(false)
  sentViaWhatsapp Boolean        @default(false)
  
  createdAt   DateTime           @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
}

enum NotificationType {
  EVENT_INVITE      // Convite para evento
  EVENT_REMINDER    // Lembrete de evento
  CONFIRMATION      // Confirmação recebida
  CANCELLATION      // Cancelamento
  PENALTY           // Penalização aplicada
  SCALE_PUBLISHED   // Escala publicada
  SYSTEM            // Sistema
}

// ==================== REPERTÓRIO ====================

model Song {
  id           String      @id @default(cuid())
  churchId     String
  title        String
  artist       String?
  key          String?     // Tom da música
  bpm          Int?
  lyrics       String?
  chords       String?
  youtubeUrl   String?
  spotifyUrl   String?
  tags         String?     // JSON array de tags
  status       SongStatus  @default(ACTIVE)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  createdById  String

  @@index([churchId])
}

enum SongStatus {
  ACTIVE      // Ativa
  ARCHIVED    // Arquivada
  LEARNING    // Em aprendizado
}

// ==================== SESSÕES (NextAuth) ====================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
